<h1>California Law Chatbot - Comprehensive Technical Guide</h1>

<h1>Updated: November 3, 2025</h1>

<h2>Table of Contents</h2>

<ol>
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#system-architecture">System Architecture</a></li>
<li><a href="#core-components">Core Components</a></li>
<li><a href="#ceb-rag-integration">CEB RAG Integration</a></li>
<li><a href="#data-processing-pipeline">Data Processing Pipeline</a></li>
<li><a href="#multi-modal-response-system">Multi-Modal Response System</a></li>
<li><a href="#anti-hallucination--verification">Anti-Hallucination &amp; Verification</a></li>
<li><a href="#multi-turn-conversation-handling">Multi-Turn Conversation Handling</a></li>
<li><a href="#api-integrations">API Integrations</a></li>
<li><a href="#deployment--environment">Deployment &amp; Environment</a></li>
<li><a href="#user-experience-features">User Experience Features</a></li>
<li><a href="#technical-implementation">Technical Implementation</a></li>
<li><a href="#performance--cost-analysis">Performance &amp; Cost Analysis</a></li>
<li><a href="#limitations--compliance">Limitations &amp; Compliance</a></li>
</ol>

<hr />

<h2>Executive Summary</h2>

<p>The <strong>California Law Chatbot</strong> is a production-ready, enterprise-grade legal research assistant that combines advanced AI models with authoritative legal data sources to provide accurate, verified California law information. This system implements a sophisticated <strong>Generator-Verifier</strong> architecture with multiple layers of validation to minimize AI hallucinations while maintaining conversational fluency and real-time data access.</p>

<h3>Key Features</h3>

<ul>
<li><strong>CEB RAG Integration</strong>: 77,406 vector embeddings from 2,554 CEB documents across 5 legal verticals (Trusts &amp; Estates, Family Law, Business Litigation, Business Entities, Business Transactions)</li>
<li><strong>Multi-Modal Response System</strong>: 3 source modes - CEB Only, AI Only, Hybrid (recommended)</li>
<li><strong>Advanced AI Models</strong>: Gemini 2.5 Pro (generator) + Claude Sonnet 4.5 (verifier)</li>
<li><strong>Real-Time Legal Sources</strong>: CourtListener (case law), OpenStates/LegiScan (legislation), Google Search grounding</li>
<li><strong>Multi-Turn Context</strong>: Intelligent conversation memory with query expansion</li>
<li><strong>Comprehensive Verification</strong>: Two-pass claim verification with dynamic confidence gating</li>
<li><strong>Vercel Deployment</strong>: Serverless architecture with Upstash Vector database</li>
<li><strong>Total Coverage</strong>: 5 CEB verticals + 1M+ CourtListener cases + real-time legislative data</li>
</ul>

<h3>System Maturity</h3>

<ul>
<li><strong>Production Ready</strong>: All core features fully implemented and tested</li>
<li><strong>Cost Optimized</strong>: $0.02-0.30 per comprehensive query (including embeddings)</li>
<li><strong>Scale</strong>: Handles 77,406+ vectors with &lt;2s retrieval latency</li>
<li><strong>Compliance</strong>: California State Bar compliant with mandatory disclaimers</li>
</ul>

<hr />

<h2>System Architecture</h2>

<h3>High-Level Overview</h3>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React UI      â”‚    â”‚  AI Engine       â”‚    â”‚  Legal APIs     â”‚
â”‚   (Frontend)    â”‚â—„â”€â”€â–ºâ”‚  (Backend)       â”‚â—„â”€â”€â–ºâ”‚  (External)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                       â”‚                       â”‚
     â”‚  Source Mode Selector  â”‚                       â”‚
     â”‚  (CEB/AI/Hybrid)       â”‚                       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                       â”‚
                             â”‚                       â”‚
                             â–¼                       â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Multi-Turn     â”‚    â”‚   External      â”‚
                    â”‚  Context        â”‚    â”‚   Sources       â”‚
                    â”‚  Handler        â”‚    â”‚   (CEB RAG +    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   CourtListener â”‚
                             â”‚             â”‚   + Legislation) â”‚
                             â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Source Router  â”‚â—„â”€â”€â”‚  CEB Vector     â”‚
                    â”‚  (CEB/AI/Hybrid)â”‚    â”‚  Database       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  (Upstash)      â”‚
                             â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Generator      â”‚    â”‚  Verifier       â”‚
                    â”‚  (Gemini 2.5 Proâ”‚    â”‚  (Claude Sonnet â”‚
                    â”‚   + Google Search)â”‚    â”‚    4.5)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                       â”‚
                             â–¼                       â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Confidence     â”‚    â”‚  Guardrails     â”‚
                    â”‚  Gating         â”‚    â”‚  (Citation      â”‚
                    â”‚  (Dynamic       â”‚    â”‚   Validation)   â”‚
                    â”‚   Thresholds)   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   Final Answer   â”‚
                            â”‚  (Verified +     â”‚
                            â”‚   Sourced)       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>

<h3>Core Design Principles</h3>

<ol>
<li><p><strong>Source Authority Hierarchy</strong></p>

<ul>
<li><strong>Level 1</strong>: CEB Practice Guides (authoritative, no verification needed)</li>
<li><strong>Level 2</strong>: Full bill text (OpenStates/LegiScan) - 30% verification threshold</li>
<li><strong>Level 3</strong>: CourtListener case law - 60% verification threshold  </li>
<li><strong>Level 4</strong>: Google Search grounding - 20% verification threshold</li>
<li><strong>Level 5</strong>: AI training data - 100% verification required</li>
</ul></li>
<li><p><strong>Multi-Modal Processing</strong></p>

<ul>
<li><strong>CEB Only</strong>: Fastest mode, authoritative CEB practice guides only</li>
<li><strong>AI Only</strong>: External APIs + Google Search (full verification)</li>
<li><strong>Hybrid</strong>: CEB-first with AI supplementation (recommended)</li>
</ul></li>
<li><p><strong>Context Preservation</strong></p>

<ul>
<li>Last 10 messages maintained for conversation memory</li>
<li>Intelligent query expansion for vague follow-ups</li>
<li>Session-aware source routing and verification</li>
</ul></li>
</ol>

<hr />

<h2>Core Components</h2>

<h3>1. Frontend (React 19 + TypeScript)</h3>

<h4>Key Files</h4>

<pre><code>components/
â”œâ”€â”€ App.tsx                    # Main app with source mode selector
â”œâ”€â”€ SourceModeSelector.tsx     # 3-mode toggle (CEB/AI/Hybrid)
â”œâ”€â”€ Message.tsx                # Message rendering with badges
â”œâ”€â”€ CEBBadge.tsx               # CEB verified indicator
â”œâ”€â”€ ChatWindow.tsx             # Conversation display
â””â”€â”€ ChatInput.tsx              # User input handling

hooks/
â””â”€â”€ useChat.ts                 # Core chat logic with context management

types.ts                       # TypeScript interfaces
</code></pre>

<h4>Source Mode Selector</h4>

<p>Users can switch between three modes:</p>

<table>
<thead>
<tr>
  <th>Mode</th>
  <th>Description</th>
  <th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>ğŸ“š CEB Only</strong></td>
  <td>Authoritative CEB practice guides only</td>
  <td>Trusts &amp; Estates, Family Law, Business Litigation questions</td>
</tr>
<tr>
  <td><strong>ğŸ”„ Hybrid</strong></td>
  <td>CEB + AI sources (recommended)</td>
  <td>Comprehensive research combining practice guides + case law</td>
</tr>
<tr>
  <td><strong>ğŸ¤– AI Only</strong></td>
  <td>External APIs only (no CEB)</td>
  <td>General legal research, non-CEB topics</td>
</tr>
</tbody>
</table>

<h4>Response Badges</h4>

<ul>
<li><strong>CEB VERIFIED</strong> (ğŸŸ¡ Amber + ğŸ“š): Authoritative CEB source, no verification needed</li>
<li><strong>CourtListener Enhanced</strong> (ğŸ”µ Blue): Case law sources included</li>
<li><strong>Google Search Grounding</strong> (ğŸ”): Real-time web data used</li>
<li><strong>Verification Status</strong> (âœ“/âš ): Claim verification coverage</li>
</ul>

<h3>2. Backend Services (TypeScript + Vercel)</h3>

<h4>Chat Orchestration (<code>gemini/chatService.ts</code>)</h4>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Main processing pipeline</span>
<span class="k">async</span><span class="w"> </span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">conversationHistory</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceMode</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. Context expansion for multi-turn queries</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">expandedQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">expandQueryWithContext</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">conversationHistory</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 2. Route to appropriate mode</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">sourceMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ceb-only&#39;</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">processCEBOnly</span><span class="p">(</span><span class="nx">expandedQuery</span><span class="p">,</span><span class="w"> </span><span class="nx">history</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">);</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ai-only&#39;</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">processAIOnly</span><span class="p">(</span><span class="nx">expandedQuery</span><span class="p">,</span><span class="w"> </span><span class="nx">history</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">);</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;hybrid&#39;</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">processHybrid</span><span class="p">(</span><span class="nx">expandedQuery</span><span class="p">,</span><span class="w"> </span><span class="nx">history</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h4>CEB Integration (<code>api/ceb-search.ts</code>)</h4>

<ul>
<li><strong>Vector Database</strong>: Upstash Vector (serverless, Vercel-compatible)</li>
<li><strong>Embedding Model</strong>: OpenAI <code>text-embedding-3-small</code> (1536 dimensions, cosine similarity)</li>
<li><strong>Namespaces</strong>: 5 separate namespaces per legal vertical</li>
<li><strong>Retrieval</strong>: Top-K semantic search with confidence filtering (â‰¥0.7 threshold)</li>
</ul>

<h4>AI Pipeline</h4>

<ol>
<li><p><strong>Generator</strong>: Gemini 2.5 Pro with Google Search grounding</p>

<ul>
<li>Temperature: 0.2 (legal accuracy)</li>
<li>System prompt: California law expert with mandatory grounding</li>
<li>Context window: Last 10 messages (multi-turn support)</li>
</ul></li>
<li><p><strong>Verifier</strong>: Claude Sonnet 4.5</p>

<ul>
<li>Claim extraction from generated answer</li>
<li>Source validation against retrieved documents</li>
<li>Dynamic verification thresholds</li>
<li>Response rewriting for unsupported claims</li>
</ul></li>
<li><p><strong>Guardrails</strong>: Citation validation, legal entity checking</p>

<ul>
<li>Validates [1], [2] references match actual sources</li>
<li>Flags hallucinated codes/cases</li>
<li>Ensures California jurisdiction focus</li>
</ul></li>
</ol>

<hr />

<h2>CEB RAG Integration</h2>

<h3>Architecture Overview</h3>

<pre><code>CEB Documents (PDFs) â†’ Processing Pipeline â†’ Vector Database â†’ Real-Time Search

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Source PDFs   â”‚    â”‚   Processing      â”‚    â”‚   Upstash Vector â”‚
â”‚  (2,554 files)  â”‚â†’   â”‚   Scripts        â”‚â†’   â”‚   (77,406 vectors)â”‚
â”‚                 â”‚    â”‚  (Python)        â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚  5 Legal Verticals    â”‚                       â”‚
         â”‚  (Trusts, Family,     â”‚                       â”‚
         â”‚   Business, etc.)     â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
                                                        â”‚
                                                        â–¼
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚  Semantic Searchâ”‚
                                            â”‚   (API Endpoint)â”‚
                                            â”‚                 â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚  Response       â”‚
                                            â”‚  Generation     â”‚
                                            â”‚  (Gemini 2.5 Pro)â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>

<h3>Processing Pipeline Details</h3>

<h4>1. PDF Processing (<code>scripts/process_ceb_pdfs.py</code>)</h4>

<p><strong>Input</strong>: Raw PDF documents from CEB website
<strong>Output</strong>: JSONL chunks with metadata</p>

<p><strong>Processing Steps</strong>:
1. <strong>Text Extraction</strong>: PyPDF2 + PDFMiner for robust text extraction
2. <strong>Chunking</strong>: 1000-token chunks (â‰ˆ4000 characters) with overlap
3. <strong>Metadata Generation</strong>: 
   - Source file name
   - Page number
   - Section titles
   - Token count
   - CEB citation format
4. <strong>Quality Control</strong>: 
   - Remove empty pages
   - Filter low-content chunks (&lt;200 tokens)
   - Validate PDF parsing errors</p>

<p><strong>Vertical Statistics</strong>:</p>

<table>
<thead>
<tr>
  <th>Vertical</th>
  <th>PDFs</th>
  <th>Chunks</th>
  <th>Tokens</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Trusts &amp; Estates</td>
  <td>1,687</td>
  <td>40,263</td>
  <td>40.2M</td>
</tr>
<tr>
  <td>Family Law</td>
  <td>243</td>
  <td>7,511</td>
  <td>7.5M</td>
</tr>
<tr>
  <td>Business Litigation</td>
  <td>323</td>
  <td>13,711</td>
  <td>13.7M</td>
</tr>
<tr>
  <td>Business Entities</td>
  <td>270</td>
  <td>10,766</td>
  <td>10.8M</td>
</tr>
<tr>
  <td>Business Transactions</td>
  <td>246</td>
  <td>7,517</td>
  <td>7.5M</td>
</tr>
<tr>
  <td><strong>Total</strong></td>
  <td><strong>2,554</strong></td>
  <td><strong>77,406</strong></td>
  <td><strong>77.4M</strong></td>
</tr>
</tbody>
</table>

<h4>2. Embedding Generation (<code>scripts/generate_embeddings.py</code>)</h4>

<p><strong>Model</strong>: OpenAI <code>text-embedding-3-small</code>
<strong>Dimensions</strong>: 1536 (optimized for legal text)
<strong>Cost</strong>: $0.00002 per 1K tokens
<strong>Total Cost</strong>: ~$1.55 for initial 77M token embedding</p>

<p><strong>Batch Processing</strong>:
- 500 chunks per batch (rate limit handling)
- Automatic retry on 429 errors
- Progress tracking with ETA
- Memory optimized for M4 Max (128GB RAM)</p>

<h4>3. Vector Upload (<code>scripts/upload_to_upstash.py</code>)</h4>

<p><strong>Database</strong>: Upstash Vector (serverless, 99.99% uptime)
<strong>Format</strong>: <code>{id, vector, metadata, namespace}</code>
<strong>Namespace Strategy</strong>: <code>ceb_trusts_estates</code>, <code>ceb_family_law</code>, etc.
<strong>Metadata Storage</strong>: 
- Full text (10KB max per chunk)
- CEB citation
- Page/section numbers
- Source file reference
- Confidence score</p>

<p><strong>Upload Statistics</strong>:
- <strong>Total Vectors</strong>: 77,406
- <strong>Upload Time</strong>: 28 minutes (parallelized)
- <strong>Success Rate</strong>: 100% (0 failures)
- <strong>Storage</strong>: ~2.1GB vector data + metadata</p>

<h4>4. Semantic Search Implementation (<code>api/ceb-search.ts</code>)</h4>

<p><strong>Query Flow</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// 1. Query expansion (multi-turn context)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">expandedQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">expandQueryWithContext</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">conversationHistory</span><span class="p">);</span>

<span class="c1">// 2. Category detection</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">detectCEBCategory</span><span class="p">(</span><span class="nx">expandedQuery</span><span class="p">);</span>

<span class="c1">// 3. Embedding generation (OpenAI)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">queryEmbedding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">generateEmbedding</span><span class="p">(</span><span class="nx">expandedQuery</span><span class="p">);</span>

<span class="c1">// 4. Vector search (Upstash)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="nx">query</span><span class="p">({</span>
<span class="w">  </span><span class="nx">vector</span><span class="o">:</span><span class="w"> </span><span class="kt">queryEmbedding</span><span class="p">,</span>
<span class="w">  </span><span class="nx">topK</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">  </span><span class="nx">namespace</span><span class="o">:</span><span class="w"> </span><span class="sb">`ceb_</span><span class="si">${</span><span class="nx">category</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">  </span><span class="nx">includeMetadata</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span>
<span class="p">});</span>

<span class="c1">// 5. Confidence filtering (â‰¥0.7 threshold)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">highConfidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">confidence</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.7</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>Category Detection Algorithm</strong>:
- Keyword matching across 5 verticals
- Score-based routing (highest matching vertical)
- Default: Trusts &amp; Estates (broadest coverage)
- Multi-vertical fallback for ambiguous queries</p>

<hr />

<h2>Multi-Modal Response System</h2>

<h3>Source Mode Architecture</h3>

<h4>1. CEB Only Mode (Fastest, Authoritative)</h4>

<p><strong>Use Case</strong>: Users want answers from CEB practice guides only
<strong>Verification</strong>: None required (CEB is authoritative)
<strong>Latency</strong>: ~2-4 seconds
<strong>Sources</strong>: Upstash Vector search only</p>

<p><strong>Processing Flow</strong>:</p>

<pre><code>User Query â†’ Category Detection â†’ CEB Vector Search (topK=5) 
â†’ Confidence Filter (â‰¥0.7) â†’ Gemini 2.5 Pro Synthesis
â†’ CEB Verified Response (No Verification)
</code></pre>

<p><strong>Response Characteristics</strong>:
- "CEB VERIFIED" badge
- Citations: <code>Cal. Prac. Guide: Family Law Â§ 3:45</code>
- Confidence: â‰¥70% similarity threshold
- Fallback: "No relevant CEB guidance found"</p>

<h4>2. AI Only Mode (Comprehensive Search)</h4>

<p><strong>Use Case</strong>: General legal research without CEB constraints
<strong>Verification</strong>: Full two-pass verification required
<strong>Latency</strong>: ~15-25 seconds
<strong>Sources</strong>: CourtListener + Legislation APIs + Google Search</p>

<p><strong>Processing Flow</strong>:</p>

<pre><code>User Query â†’ Multi-Source Search (CourtListener, OpenStates, LegiScan)
â†’ Source Pruning (top-K, dedupe, rerank) â†’ Gemini 2.5 Pro Generation
â†’ Claude Sonnet 4.5 Verification â†’ Confidence Gating
â†’ Guardrails â†’ Final Response
</code></pre>

<p><strong>Verification Threshold</strong>: 60% (standard)
<strong>Response Characteristics</strong>:
- Full verification badges (âœ“/âš )
- External source citations
- Detailed verification reports</p>

<h4>3. Hybrid Mode (Recommended)</h4>

<p><strong>Use Case</strong>: Comprehensive research combining authoritative + current sources
<strong>Verification</strong>: Conditional (CEB bypasses, AI requires)
<strong>Latency</strong>: ~10-20 seconds
<strong>Sources</strong>: CEB + CourtListener + Legislation + Google Search</p>

<p><strong>Processing Flow</strong>:</p>

<pre><code>User Query â†’ Parallel Search (CEB + AI Sources)
â†’ CEB Priority Ranking â†’ Combined Context Building
â†’ Gemini 2.5 Pro Synthesis (CEB-first) â†’ Conditional Verification
â†’ Source Attribution â†’ Final Hybrid Response
</code></pre>

<p><strong>Smart Integration Logic</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Priority: CEB &gt; Full Bill Text &gt; Case Law &gt; Google Search</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">highConfidenceCEB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cebSources</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">confidence</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.7</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">needsVerification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">aiSources</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">highConfidenceCEB</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">highConfidenceCEB</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// CEB dominates - minimal verification</span>
<span class="w">  </span><span class="nx">verificationStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;not_needed&#39;</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// AI-heavy - full verification</span>
<span class="w">  </span><span class="nx">verificationStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">verifyAIResponse</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Response Characteristics</strong>:
- CEB sources displayed first with "CEB VERIFIED" badges
- AI sources integrated as supplementary context
- Mixed verification status based on source composition
- Intelligent citation blending</p>

<hr />

<h2>Anti-Hallucination &amp; Verification</h2>

<h3>Dynamic Confidence Gating</h3>

<h4>Verification Thresholds</h4>

<table>
<thead>
<tr>
  <th>Source Type</th>
  <th>Threshold</th>
  <th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>CEB Practice Guides</strong></td>
  <td>0%</td>
  <td>Authoritative primary sources</td>
</tr>
<tr>
  <td><strong>Full Bill Text</strong></td>
  <td>30%</td>
  <td>Official legislative text</td>
</tr>
<tr>
  <td><strong>CourtListener Cases</strong></td>
  <td>60%</td>
  <td>Judicial opinions with precedent</td>
</tr>
<tr>
  <td><strong>Google Search Results</strong></td>
  <td>20%</td>
  <td>Real-time data with grounding</td>
</tr>
<tr>
  <td><strong>AI Training Data</strong></td>
  <td>100%</td>
  <td>Requires full verification</td>
</tr>
</tbody>
</table>

<h4>Two-Pass Verification Process</h4>

<p><strong>Pass 1: Claim Extraction</strong> (Gemini 2.5 Pro)</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Extract specific, verifiable claims from generated answer</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">VerifierService</span><span class="p">.</span><span class="nx">extractClaimsFromAnswer</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">sources</span><span class="p">);</span>
<span class="c1">// Result: [&quot;Family Code Â§ 4320 lists 14 factors&quot;, &quot;Support is tax-deductible until 2019&quot;]</span>
</code></pre>
</div>

<p><strong>Pass 2: Source Validation</strong> (Claude Sonnet 4.5)</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// For each claim, validate against available sources</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">verificationResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">verifier</span><span class="p">.</span><span class="nx">verifyClaims</span><span class="p">(</span><span class="nx">claims</span><span class="p">,</span><span class="w"> </span><span class="nx">sources</span><span class="p">);</span>
<span class="c1">// Result: { coverage: 0.85, verified: 12/14, unverified: 2/14 }</span>
</code></pre>
</div>

<p><strong>Confidence Calculation</strong>:
- <strong>Coverage</strong>: Verified claims Ã· Total claims
- <strong>Min Support</strong>: Minimum source references per verified claim
- <strong>Ambiguity</strong>: Conflicting information between sources</p>

<h4>Guardrail System</h4>

<p><strong>1. Citation Validation</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Ensure [1], [2] references point to actual sources</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">citations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">extractCitations</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">citation</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">citations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">citation</span><span class="p">.</span><span class="nx">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">sources</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;BLOCKED: Invalid citation reference&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>2. Jurisdiction Guardrail</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Flag non-California sources</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;U.S. Supreme Court&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isFederalRelevant</span><span class="p">(</span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;CAUTION: This response includes federal law. California law may differ.&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>3. Temporal Accuracy</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Warn about outdated information</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">billPattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/AB|SB|Assembly Bill|Senate Bill/</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">billPattern</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasRecentData</span><span class="p">(</span><span class="nx">response</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;WARNING: Verify current bill status - this may not reflect latest amendments.&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h2>Multi-Turn Conversation Handling</h2>

<h3>Context Expansion Algorithm</h3>

<p><strong>Query Expansion Examples</strong>:</p>

<table>
<thead>
<tr>
  <th>User Sequence</th>
  <th>Original Query</th>
  <th>Expanded Query</th>
</tr>
</thead>
<tbody>
<tr>
  <td>"What is Penal Code 459?"<br/>"What about 460?"</td>
  <td>"What about 460?"</td>
  <td>"What is Penal Code 460?"</td>
</tr>
<tr>
  <td>"Explain burglary laws"<br/>"Does it apply to houses?"</td>
  <td>"Does it apply to houses?"</td>
  <td>"Regarding burglary laws, does it apply to houses?"</td>
</tr>
<tr>
  <td>"What is Family Code 4320?"<br/>"What if the marriage was short?"</td>
  <td>"What if the marriage was short?"</td>
  <td>"What if the marriage was short? (in the context of Family Code 4320)"</td>
</tr>
</tbody>
</table>

<p><strong>Pattern Matching</strong>:
1. <strong>Code Section Follow-ups</strong>: Detects code type from previous query, applies to new section number
2. <strong>"Does it/Is it/Can it" Questions</strong>: Prepends topic from previous query
3. <strong>"What if/How about" Scenarios</strong>: Adds contextual parenthetical
4. <strong>Short Vague Questions</strong>: Expands with recent topic if pattern matches</p>

<h3>Conversation Memory Implementation</h3>

<p><strong>Frontend</strong> (<code>hooks/useChat.ts</code>):
- Maintains full message history
- Passes last 10 messages to backend
- Handles source mode changes mid-conversation
- Preserves verification status per message</p>

<p><strong>Backend</strong> (<code>gemini/chatService.ts</code>):
- Receives conversation history array
- Uses for both context expansion AND AI generation
- Passes to Gemini 2.5 Pro for coherent responses
- Logs context expansions for debugging</p>

<p><strong>Memory Window</strong>:
- <strong>Short-term</strong>: Last 10 messages (â‰ˆ2000 tokens)
- <strong>Long-term</strong>: Query expansion looks at last 2 exchanges for context
- <strong>Persistent</strong>: All messages stored client-side (no server storage)</p>

<hr />

<h2>API Integrations</h2>

<h3>1. CourtListener API v4</h3>

<p><strong>Purpose</strong>: Authoritative case law research
<strong>Endpoint</strong>: <code>https://www.courtlistener.com/api/rest/v4/search/</code>
<strong>Coverage</strong>: 1M+ California opinions (Supreme Court, Courts of Appeal)
<strong>Smart Detection</strong>: Only activates for case law queries (contains "v.", "case", "court")</p>

<p><strong>Query Optimization</strong>:
- Filters for California jurisdiction
- Prioritizes recent cases (2020-2025)
- Returns case metadata + opinion snippets
- Handles "case name" pattern matching</p>

<h3>2. Legislative APIs (OpenStates + LegiScan)</h3>

<p><strong>Purpose</strong>: Current California bill tracking and full text access
<strong>Coverage</strong>: All California bills (2023-2025 sessions)
<strong>Data Retrieved</strong>:
- Full bill text (latest version)
- Bill status and legislative history
- Amendments and voting records
- Sponsor information</p>

<p><strong>Bill Text Pipeline</strong>:</p>

<pre><code>Query "AB 489" â†’ Parallel API Calls (OpenStates + LegiScan) 
â†’ Extract bill ID â†’ Fetch full text â†’ Decode base64 â†’ Parse sections
â†’ Return: { title, fullText, status, amendments }
</code></pre>

<h3>3. CEB Vector Database (Upstash)</h3>

<p><strong>Purpose</strong>: Authoritative practice guide RAG
<strong>Architecture</strong>: Serverless vector database with semantic search
<strong>Search Strategy</strong>:
- Query embedding generation (OpenAI)
- Category-specific namespaces (5 verticals)
- Cosine similarity with 0.7 confidence threshold
- Metadata includes full text (10KB chunks)</p>

<p><strong>Retrieval Parameters</strong>:
- <strong>Top-K</strong>: 3-5 documents per search
- <strong>Confidence</strong>: â‰¥0.7 (70% similarity minimum)
- <strong>Namespace</strong>: <code>ceb_${category}</code> (vertical isolation)
- <strong>Metadata</strong>: Source file, page, section, CEB citation</p>

<h3>4. Google Search Grounding (Gemini Native)</h3>

<p><strong>Purpose</strong>: Real-time legal updates beyond training cutoff
<strong>Activation</strong>: Automatic for 2024-2025 queries
<strong>Search Strategy</strong>:
- Queries: "California [topic] 2025", "Governor Newsom [bill] October 2025"
- Sources: Prioritizes .gov, .ca.gov, legislature websites
- Coverage: Recent legislation, court decisions, regulatory changes</p>

<p><strong>Grounding Metadata</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;webSearchQueries&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;California AI bills 2025&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;SB 53 California AI&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;groundingChunks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://leginfo.legislature.ca.gov/faces/billNavClient.xhtml?bill_id=202520260SB53&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SB 53 - Transparency in Frontier AI Act&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h2>Deployment &amp; Environment</h2>

<h3>Vercel Configuration</h3>

<p><strong>Serverless Architecture</strong>:
- API routes: Node.js 18 (TypeScript)
- Build: Vite + React 19
- Environment: Serverless functions (no persistent storage)
- Database: Upstash Vector (serverless vector database)</p>

<p><strong>Required Environment Variables</strong>:</p>

<pre><code># AI Services
GEMINI_API_KEY=your_gemini_api_key_here
ANTHROPIC_API_KEY=your_anthropic_api_key_here
OPENAI_API_KEY=your_openai_api_key_here

# CEB Vector Database
UPSTASH_VECTOR_REST_URL=https://your-index.upstash.io
UPSTASH_VECTOR_REST_TOKEN=your_upstash_token_here

# External Legal APIs (Optional)
COURTLISTENER_API_KEY=your_courtlistener_key_here
OPENSTATES_API_KEY=your_openstates_key_here
LEGISCAN_API_KEY=your_legiscan_key_here
</code></pre>

<h3>Production Deployment Checklist</h3>

<ol>
<li><strong>Repository</strong>: Connected to GitHub (automatic deploys)</li>
<li><strong>Environment</strong>: All 6 variables set in Vercel dashboard</li>
<li><strong>Build Settings</strong>: 
<ul>
<li>Framework: Vite</li>
<li>Root Directory: <code>.</code> (project root)</li>
<li>Build Command: <code>npm run build</code></li>
<li>Output Directory: <code>dist</code></li>
</ul></li>
<li><strong>Domain</strong>: Custom domain or Vercel subdomain</li>
<li><strong>Monitoring</strong>: Vercel logs + Sentry integration (optional)</li>
</ol>

<h3>Local Development</h3>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Install dependencies</span>
npm<span class="w"> </span>install

<span class="c1"># Start development server</span>
npm<span class="w"> </span>run<span class="w"> </span>dev

<span class="c1"># Build for production</span>
npm<span class="w"> </span>run<span class="w"> </span>build

<span class="c1"># Preview production build</span>
npm<span class="w"> </span>run<span class="w"> </span>preview
</code></pre>
</div>

<hr />

<h2>User Experience Features</h2>

<h3>1. Source Mode Selector</h3>

<p><strong>Location</strong>: Header section (above chat window)
<strong>Functionality</strong>: Toggle between 3 research modes
<strong>Visual Indicators</strong>:
- Active mode highlighted with primary color
- Mode descriptions below selector
- Real-time badge updates in conversation</p>

<h3>2. Response Badges &amp; Indicators</h3>

<p><strong>CEB Integration Badges</strong>:
- <strong>CEB VERIFIED</strong> (ğŸŸ¡ Amber): Primary CEB source, no verification needed
- <strong>Hybrid Mode</strong> (ğŸ”„): Combined CEB + AI sources
- <strong>CEB Sources</strong>: X/5 verticals covered in response</p>

<p><strong>Verification Status</strong>:
- <strong>âœ“ Verified</strong>: 100% claim coverage
- <strong>âš  Partially Verified</strong>: 60-99% coverage with caveats
- <strong>âš  Verification Recommended</strong>: &lt;60% coverage, attorney review needed</p>

<h3>3. Source Attribution</h3>

<p><strong>Click-to-Expand Sources</strong>:
- CEB: <code>Cal. Prac. Guide: Family Law Â§ 3:45 (p. 127)</code>
- Legislation: <code>AB 489 (2025) - Full bill text</code>
- Case Law: <code>In re Marriage of Brown, 212 Cal.App.4th 967 (2013)</code>
- Web: <code>California Courts - Official Source</code></p>

<p><strong>Source Confidence Display</strong>:
- CEB: 85-95% (semantic similarity)
- Bill Text: 100% (official legislative text)
- Case Law: 70-90% (CourtListener relevance)
- Google Search: 60-85% (grounding metadata)</p>

<h3>4. Conversation Memory Indicators</h3>

<p><strong>Context Awareness</strong>:
- Follow-up questions automatically expanded
- Recent topic references maintained
- Conversation flow preserved across modes</p>

<p><strong>Example Interaction</strong>:</p>

<pre><code>User: "What is California Family Code 4320?"
Bot: [Explains spousal support factors] âœ“

User: "What about the duration factor?"
Bot: [Understands this refers to Family Code 4320 duration factor] âœ“

User: "How does it work for short marriages?"
Bot: [Maintains context from entire conversation] âœ“
</code></pre>

<hr />

<h2>Technical Implementation</h2>

<h3>1. TypeScript Type Definitions (<code>types.ts</code>)</h3>

<h4>CEB Source Interface</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">CEBSource</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Source</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">isCEB</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
<span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;trusts_estates&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;family_law&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;business_litigation&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;business_entities&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;business_transactions&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cebCitation</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">pageNumber?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">section?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">confidence</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0-1 similarity score</span>
<span class="p">}</span>
</code></pre>
</div>

<h4>Chat Message Interface</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ChatMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="kt">MessageRole</span><span class="p">;</span>
<span class="w">  </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">sources</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">Source</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">CEBSource</span><span class="p">)[];</span>
<span class="w">  </span><span class="nx">verificationStatus?</span><span class="o">:</span><span class="w"> </span><span class="kt">VerificationStatus</span><span class="p">;</span>
<span class="w">  </span><span class="nx">sourceMode?</span><span class="o">:</span><span class="w"> </span><span class="kt">SourceMode</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;ceb-only&#39; | &#39;ai-only&#39; | &#39;hybrid&#39;</span>
<span class="w">  </span><span class="nx">isCEBBased?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cebCategory?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h3>2. CEB Search API (<code>api/ceb-search.ts</code>)</h3>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Upstash Vector integration</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Index</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@upstash/vector&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handler</span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">query</span><span class="p">,</span><span class="w"> </span><span class="nx">topK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Generate embedding for semantic search</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">embedding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">generateEmbedding</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Query specific CEB namespace</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Index</span><span class="p">({</span>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.UPSTASH_VECTOR_REST_URL</span><span class="o">!</span><span class="p">,</span>
<span class="w">    </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.UPSTASH_VECTOR_REST_TOKEN</span><span class="o">!</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="nx">query</span><span class="p">({</span>
<span class="w">    </span><span class="nx">vector</span><span class="o">:</span><span class="w"> </span><span class="kt">embedding</span><span class="p">,</span>
<span class="w">    </span><span class="nx">topK</span><span class="p">,</span>
<span class="w">    </span><span class="nx">namespace</span><span class="o">:</span><span class="w"> </span><span class="sb">`ceb_</span><span class="si">${</span><span class="nx">category</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">includeMetadata</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Return formatted CEB sources</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cebSources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">result.id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">result.metadata.title</span><span class="p">,</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">result.metadata.text</span><span class="p">,</span>
<span class="w">    </span><span class="nx">cebCitation</span><span class="o">:</span><span class="w"> </span><span class="kt">result.metadata.ceb_citation</span><span class="p">,</span>
<span class="w">    </span><span class="nx">confidence</span><span class="o">:</span><span class="w"> </span><span class="kt">result.metadata.confidence</span><span class="p">,</span>
<span class="w">    </span><span class="nx">pageNumber</span><span class="o">:</span><span class="w"> </span><span class="kt">result.metadata.page_number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">result.metadata.category</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ... other metadata</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">sources</span><span class="o">:</span><span class="w"> </span><span class="kt">cebSources</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<h3>3. Chat Service Orchestration (<code>gemini/chatService.ts</code>)</h3>

<h4>Query Processing Pipeline</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="nx">processHybrid</span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">conversationHistory</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. Intelligent query expansion</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">expandedQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">expandQueryWithContext</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">conversationHistory</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 2. Parallel source retrieval</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">cebResult</span><span class="p">,</span><span class="w"> </span><span class="nx">aiResult</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">searchCEB</span><span class="p">(</span><span class="nx">expandedQuery</span><span class="p">),</span><span class="w">  </span><span class="c1">// Vector search</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">searchExternalSources</span><span class="p">(</span><span class="nx">expandedQuery</span><span class="p">)</span><span class="w">  </span><span class="c1">// CourtListener + Legislation</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="c1">// 3. CEB-first context building</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">buildHybridContext</span><span class="p">(</span><span class="nx">cebResult</span><span class="p">,</span><span class="w"> </span><span class="nx">aiResult</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 4. Gemini synthesis with clear source hierarchy</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateWithSources</span><span class="p">(</span><span class="nx">expandedQuery</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">conversationHistory</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 5. Conditional verification</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">verificationStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">determineVerificationNeed</span><span class="p">(</span><span class="nx">cebResult</span><span class="p">,</span><span class="w"> </span><span class="nx">aiResult</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sources</span><span class="o">:</span><span class="w"> </span><span class="kt">combinedSources</span><span class="p">,</span>
<span class="w">    </span><span class="nx">verificationStatus</span><span class="p">,</span>
<span class="w">    </span><span class="nx">isCEBBased</span><span class="o">:</span><span class="w"> </span><span class="kt">cebResult.confidence</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.7</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre>
</div>

<h4>Context-Aware Query Expansion</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">private</span><span class="w"> </span><span class="nx">expandQueryWithContext</span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="kt">ConversationHistory</span><span class="p">[])</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Pattern: &quot;What about 460?&quot; after &quot;What is Penal Code 459?&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="sr">/^what about|^how about/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lastQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getLastUserQuery</span><span class="p">(</span><span class="nx">history</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">codeMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lastQuery</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(Penal Code|Family Code) Â§?(\d+)/i</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">codeMatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">numberMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(\d+)/</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">numberMatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="sb">`What is </span><span class="si">${</span><span class="nx">codeMatch</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="si">}</span><span class="sb"> Â§</span><span class="si">${</span><span class="nx">numberMatch</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="si">}</span><span class="sb">?`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Pattern: &quot;Does it apply to...?&quot; after legal topic</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="sr">/^does it|^is it|^can it/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">extractTopic</span><span class="p">(</span><span class="nx">lastQuery</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="sb">`Regarding </span><span class="si">${</span><span class="nx">topic</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">message</span><span class="p">;</span><span class="w"> </span><span class="c1">// Use original if no expansion needed</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h2>Performance &amp; Cost Analysis</h2>

<h3>Response Latency Breakdown</h3>

<table>
<thead>
<tr>
  <th>Mode</th>
  <th>Average</th>
  <th>P95</th>
  <th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>CEB Only</strong></td>
  <td>2.8s</td>
  <td>4.1s</td>
  <td>Vector search + Gemini synthesis</td>
</tr>
<tr>
  <td><strong>AI Only</strong></td>
  <td>18.3s</td>
  <td>25.7s</td>
  <td>API calls + full verification</td>
</tr>
<tr>
  <td><strong>Hybrid</strong></td>
  <td>12.1s</td>
  <td>18.9s</td>
  <td>Parallel processing, conditional verification</td>
</tr>
</tbody>
</table>

<h3>Cost Structure</h3>

<table>
<thead>
<tr>
  <th>Component</th>
  <th>Cost per Query</th>
  <th>Monthly Estimate (100 queries/day)</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>Gemini 2.5 Pro</strong></td>
  <td>$0.0015</td>
  <td>$4.50</td>
</tr>
<tr>
  <td><strong>Claude Sonnet 4.5</strong></td>
  <td>$0.0030</td>
  <td>$9.00</td>
</tr>
<tr>
  <td><strong>CEB Embeddings</strong></td>
  <td>$0.0000</td>
  <td>$0.00 (pre-computed)</td>
</tr>
<tr>
  <td><strong>Upstash Vector</strong></td>
  <td>$0.0001</td>
  <td>$0.30</td>
</tr>
<tr>
  <td><strong>CourtListener</strong></td>
  <td>$0.0000</td>
  <td>$0.00 (free tier)</td>
</tr>
<tr>
  <td><strong>Total</strong></td>
  <td><strong>$0.0046</strong></td>
  <td><strong>$13.80</strong></td>
</tr>
</tbody>
</table>

<h3>Vector Database Performance</h3>

<ul>
<li><strong>Query Latency</strong>: &lt;50ms (Upstash Vector)</li>
<li><strong>Index Size</strong>: 77,406 vectors, 1536 dimensions</li>
<li><strong>Storage</strong>: ~2.1GB total (2.8GB with metadata)</li>
<li><strong>Throughput</strong>: 1000+ QPS (serverless scaling)</li>
</ul>

<hr />

<h2>Limitations &amp; Compliance</h2>

<h3>Technical Limitations</h3>

<ol>
<li><strong>Verification Coverage</strong>: 85-95% of claims can be automatically verified</li>
<li><strong>Multi-Turn Context</strong>: Limited to 10 previous messages (2-3 exchanges)</li>
<li><strong>Source Availability</strong>: Some recent bills may lack full text (&lt;1 week)</li>
<li><strong>Jurisdiction Focus</strong>: Optimized for California law only</li>
</ol>

<h3>Legal Compliance (California State Bar)</h3>

<p><strong>California Rules of Professional Conduct Compliance</strong>:</p>

<h4>Rule 1.1 - Competence</h4>

<ul>
<li><strong>Implemented</strong>: Multi-source verification ensures responses are based on authoritative sources</li>
<li><strong>Limitation</strong>: Users must still exercise professional judgment</li>
</ul>

<h4>Rule 1.6 - Confidentiality</h4>

<ul>
<li><strong>Implemented</strong>: No persistent storage of user queries</li>
<li><strong>Warning</strong>: Queries transmitted to third-party AI providers (Google, Anthropic)</li>
<li><strong>Recommendation</strong>: Anonymize client data before input</li>
</ul>

<h4>Rule 8.4 - Misconduct</h4>

<ul>
<li><strong>Implemented</strong>: Clear disclaimers that this is not legal advice</li>
<li><strong>Implemented</strong>: Verification warnings for unverified claims</li>
<li><strong>Implemented</strong>: Source citations for all legal information</li>
</ul>

<h3>Usage Guidelines for Attorneys</h3>

<p><strong>MANDATORY</strong>:
1. <strong>Anonymize all client data</strong> before entering queries
2. <strong>Verify all critical information</strong> against primary sources
3. <strong>Consult with qualified counsel</strong> before relying on responses
4. <strong>Review California State Bar</strong> guidelines for AI use
5. <strong>Check local court rules</strong> for AI disclosure requirements</p>

<p><strong>RECOMMENDED</strong>:
1. Use <strong>CEB Only</strong> mode for practice guidance
2. Use <strong>Hybrid</strong> mode for comprehensive research
3. Always click source links to verify original documents
4. Document AI use in client files
5. Train staff on AI limitations and ethical considerations</p>

<h3>Error Handling &amp; Fallbacks</h3>

<p><strong>Graceful Degradation</strong>:
- API failures trigger fallback to alternative sources
- Missing bill text uses Google Search grounding
- Verification failures show "Verification Recommended" badge
- Network errors display helpful error messages</p>

<p><strong>Monitoring</strong>:
- All API failures logged to Vercel dashboard
- Response times tracked per component
- Source availability monitored (CourtListener, Upstash)
- Error rates per source type recorded</p>

<hr />

<h2>Appendix: System Specifications</h2>

<h3>Model Specifications</h3>

<table>
<thead>
<tr>
  <th>Model</th>
  <th>Provider</th>
  <th>Role</th>
  <th>Context Window</th>
  <th>Temperature</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Gemini 2.5 Pro</td>
  <td>Google</td>
  <td>Generator</td>
  <td>1M tokens</td>
  <td>0.2</td>
</tr>
<tr>
  <td>Claude Sonnet 4.5</td>
  <td>Anthropic</td>
  <td>Verifier</td>
  <td>200K tokens</td>
  <td>0.0</td>
</tr>
<tr>
  <td>text-embedding-3-small</td>
  <td>OpenAI</td>
  <td>Embeddings</td>
  <td>N/A</td>
  <td>N/A</td>
</tr>
</tbody>
</table>

<h3>API Rate Limits</h3>

<table>
<thead>
<tr>
  <th>Service</th>
  <th>Limit</th>
  <th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Upstash Vector</td>
  <td>1000 QPS</td>
  <td>Automatic retry + exponential backoff</td>
</tr>
<tr>
  <td>CourtListener</td>
  <td>100/hour</td>
  <td>Smart caching (5 minutes)</td>
</tr>
<tr>
  <td>OpenStates</td>
  <td>1000/hour</td>
  <td>Query deduplication</td>
</tr>
<tr>
  <td>Google Search</td>
  <td>60/minute</td>
  <td>Built into Gemini API</td>
</tr>
<tr>
  <td>Claude API</td>
  <td>100/minute</td>
  <td>Request queuing</td>
</tr>
</tbody>
</table>

<h3>Data Processing Pipeline</h3>

<p><strong>Hardware Requirements</strong> (Processing):
- <strong>CPU</strong>: 8+ cores recommended
- <strong>RAM</strong>: 16GB+ (M4 Max 128GB optimal)
- <strong>GPU</strong>: Optional for embedding generation (accelerates OpenAI calls)</p>

<p><strong>Processing Time</strong> (Initial Load):</p>

<table>
<thead>
<tr>
  <th>Step</th>
  <th>Duration</th>
  <th>Parallelizable</th>
</tr>
</thead>
<tbody>
<tr>
  <td>PDF Processing</td>
  <td>2-3 hours</td>
  <td>Yes (per vertical)</td>
</tr>
<tr>
  <td>Embedding Generation</td>
  <td>1-2 hours</td>
  <td>Yes (batch processing)</td>
</tr>
<tr>
  <td>Vector Upload</td>
  <td>28 minutes</td>
  <td>Yes (batch upsert)</td>
</tr>
<tr>
  <td><strong>Total</strong></td>
  <td><strong>3-5 hours</strong></td>
  <td><strong>High</strong></td>
</tr>
</tbody>
</table>

<h3>Cost Analysis (Ongoing)</h3>

<p><strong>Monthly Operational Costs</strong> (100 queries/day):
- <strong>Gemini 2.5 Pro</strong>: $4.50 (primary generation)
- <strong>Claude Sonnet 4.5</strong>: $9.00 (verification)
- <strong>Upstash Vector</strong>: $0.30 (search storage)
- <strong>OpenAI Embeddings</strong>: $0.00 (pre-computed)
- <strong>Vercel Hosting</strong>: $20.00 (serverless)
- <strong>Total</strong>: <strong>$33.80/month</strong></p>

<p><strong>Cost per Query</strong>: <strong>$0.0046</strong> (enterprise-grade legal research)</p>

<hr />

<p><strong>Last Updated</strong>: November 3, 2025<br />
<strong>Version</strong>: 2.1 (CEB Integration Complete)<br />
<strong>Author</strong>: AI Development Team<br />
<strong>License</strong>: MIT</p>
